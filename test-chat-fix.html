<!DOCTYPE html>
<html>
<head>
    <title>Test Chat Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîß Chat Fix Test</h1>
    
    <div class="test-section info">
        <h3>üìã Test Instructions</h3>
        <p>This page will test if the chat message sending is working after our fixes.</p>
        <ol>
            <li>Go to your chat page: <a href="https://skillsxchangee.onrender.com/chat/2" target="_blank">https://skillsxchangee.onrender.com/chat/2</a></li>
            <li>Open browser console (F12)</li>
            <li>Look for the debug information we added</li>
            <li>Try sending a message and check the console logs</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h3>üîç URL Generation Test</h3>
        <p>Test if the URL generation is working correctly:</p>
        <button onclick="testUrlGeneration()">Test URL Generation</button>
        <div id="url-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>üì° Direct API Test</h3>
        <p>Test the chat API directly (you'll need to get CSRF token from your chat page):</p>
        <input type="text" id="csrfToken" placeholder="Paste CSRF token here" />
        <input type="text" id="testMessage" placeholder="Test message" value="Test message from fix" />
        <button onclick="testDirectAPI()">Test Direct API</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>üåê CORS Test</h3>
        <p>Test if CORS is working:</p>
        <button onclick="testCORS()">Test CORS</button>
        <div id="cors-result" class="result"></div>
    </div>
    
    <script>
    function testUrlGeneration() {
        const resultDiv = document.getElementById('url-result');
        const baseUrl = window.location.origin;
        const testUrl = baseUrl + '/chat/2/message';
        
        resultDiv.innerHTML = `
            <strong>URL Generation Test:</strong><br>
            Base URL: ${baseUrl}<br>
            Generated URL: ${testUrl}<br>
            <span style="color: green;">‚úÖ URL generation looks correct</span>
        `;
    }
    
    async function testDirectAPI() {
        const resultDiv = document.getElementById('api-result');
        const csrfToken = document.getElementById('csrfToken').value;
        const message = document.getElementById('testMessage').value;
        
        if (!csrfToken) {
            resultDiv.innerHTML = '<span style="color: red;">‚ùå Please enter CSRF token first</span>';
            return;
        }
        
        resultDiv.innerHTML = 'Testing...';
        
        try {
            const response = await fetch('https://skillsxchangee.onrender.com/chat/2/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ message: message }),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                resultDiv.innerHTML = `
                    <span style="color: green;">‚úÖ API Test Successful!</span><br>
                    Status: ${response.status}<br>
                    Response: ${JSON.stringify(data, null, 2)}
                `;
            } else {
                resultDiv.innerHTML = `
                    <span style="color: orange;">‚ö†Ô∏è API Test Failed</span><br>
                    Status: ${response.status}<br>
                    Response: ${JSON.stringify(data, null, 2)}
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <span style="color: red;">‚ùå API Test Error</span><br>
                Error: ${error.message}<br>
                Type: ${error.name}
            `;
        }
    }
    
    async function testCORS() {
        const resultDiv = document.getElementById('cors-result');
        resultDiv.innerHTML = 'Testing CORS...';
        
        try {
            const response = await fetch('https://skillsxchangee.onrender.com/chat/2/messages', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                resultDiv.innerHTML = `
                    <span style="color: green;">‚úÖ CORS Test Successful!</span><br>
                    Status: ${response.status}<br>
                    CORS headers are working
                `;
            } else {
                resultDiv.innerHTML = `
                    <span style="color: orange;">‚ö†Ô∏è CORS Test Failed</span><br>
                    Status: ${response.status}
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <span style="color: red;">‚ùå CORS Test Error</span><br>
                Error: ${error.message}<br>
                This might indicate a CORS issue
            `;
        }
    }
    
    // Auto-test URL generation on page load
    window.onload = function() {
        testUrlGeneration();
    };
    </script>
</body>
</html>