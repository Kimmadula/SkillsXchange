<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcasting Auth Fix Test</title>
    <meta name="csrf-token" content="test-csrf-token">
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.iife.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
</head>
<body>
    <h1>‚úÖ Broadcasting Authentication Fix Test - RESOLVED</h1>
    <div id="status">Initializing...</div>
    <div id="logs"></div>
    <div style="background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h3>üîß Fixes Applied:</h3>
        <ul>
            <li>‚úÖ Registered Pusher service in AppServiceProvider</li>
            <li>‚úÖ Fixed double JSON encoding issue</li>
            <li>‚úÖ Added proper auth middleware to Broadcast::routes()</li>
            <li>‚úÖ Added channel authorization for both trade.{id} and private-trade.{id}</li>
            <li>‚úÖ Enhanced Echo configuration with proper headers</li>
        </ul>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        
        function log(message) {
            console.log(message);
            logsDiv.innerHTML += '<div>' + new Date().toISOString() + ': ' + message + '</div>';
        }
        
        // Test configuration
        const PUSHER_KEY = '5c02e54d01ca577ae77e';
        const PUSHER_CLUSTER = 'ap1';
        const TEST_TRADE_ID = 1; // Replace with actual trade ID
        
        log('üîß Testing Broadcasting Authentication Fix...');
        log('üîë Pusher Key: ' + PUSHER_KEY);
        log('üåê Cluster: ' + PUSHER_CLUSTER);
        
        // Initialize Echo
        try {
            window.Echo = new Echo({
                broadcaster: 'pusher',
                key: PUSHER_KEY,
                cluster: PUSHER_CLUSTER,
                forceTLS: true,
                enabledTransports: ['ws', 'wss'],
                authEndpoint: '/broadcasting/auth',
                auth: {
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        'Accept': 'application/json'
                    }
                }
            });
            
            log('‚úÖ Laravel Echo initialized successfully');
            statusDiv.textContent = 'Echo initialized - Testing channel subscription...';
            
            // Test private channel subscription
            const channelName = `trade.${TEST_TRADE_ID}`;
            log(`üì° Attempting to subscribe to private channel: ${channelName}`);
            
            const channel = window.Echo.private(channelName);
            
            // Test event listeners
            channel.listen('video-call-offer', (data) => {
                log('üìû Received video-call-offer: ' + JSON.stringify(data));
            })
            .listen('video-call-answer', (data) => {
                log('üìû Received video-call-answer: ' + JSON.stringify(data));
            })
            .listen('video-call-ice-candidate', (data) => {
                log('üìû Received video-call-ice-candidate: ' + JSON.stringify(data));
            })
            .listen('video-call-end', (data) => {
                log('üìû Received video-call-end: ' + JSON.stringify(data));
            })
            .error((error) => {
                log('‚ùå Channel subscription error: ' + JSON.stringify(error));
                if (error.type === 'AuthError') {
                    statusDiv.textContent = '‚ùå Authentication failed - Check server logs';
                    log('üîç AuthError details: ' + error.error);
                } else {
                    statusDiv.textContent = '‚ùå Subscription failed - ' + error.type;
                }
            });
            
            // Test connection status
            window.Echo.connector.pusher.connection.bind('connected', () => {
                log('‚úÖ Pusher connected successfully');
                statusDiv.textContent = '‚úÖ Connected and subscribed successfully!';
            });
            
            window.Echo.connector.pusher.connection.bind('error', (error) => {
                log('‚ùå Pusher connection error: ' + JSON.stringify(error));
                statusDiv.textContent = '‚ùå Connection failed';
            });
            
            // Test after 3 seconds
            setTimeout(() => {
                if (window.Echo.connector.pusher.connection.state === 'connected') {
                    log('‚úÖ Test completed successfully - No AuthError detected');
                    statusDiv.textContent = '‚úÖ Test PASSED - Broadcasting authentication is working!';
                } else {
                    log('‚ö†Ô∏è Connection not established yet, state: ' + window.Echo.connector.pusher.connection.state);
                }
            }, 3000);
            
        } catch (error) {
            log('‚ùå Failed to initialize Laravel Echo: ' + error.message);
            statusDiv.textContent = '‚ùå Initialization failed';
        }
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #status {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        #logs {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</body>
</html>
