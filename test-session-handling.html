<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Handling Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>Session Handling Test</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Test Instructions:</strong>
                            <ol class="mb-0 mt-2">
                                <li>This page simulates the session monitoring system</li>
                                <li>Click "Start Test" to begin monitoring</li>
                                <li>Wait for the session warning (5 minutes before expiration)</li>
                                <li>Test the "Extend Session" functionality</li>
                                <li>Test the automatic logout after session expiration</li>
                            </ol>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title">Session Status</h5>
                                        <p class="card-text">
                                            <strong>Status:</strong> <span id="session-status" class="badge bg-success">Active</span><br>
                                            <strong>Last Activity:</strong> <span id="last-activity">-</span><br>
                                            <strong>Time Remaining:</strong> <span id="time-remaining">-</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h5 class="card-title">Test Controls</h5>
                                        <div class="d-grid gap-2">
                                            <button id="start-test" class="btn btn-primary">
                                                <i class="fas fa-play me-2"></i>Start Test
                                            </button>
                                            <button id="simulate-activity" class="btn btn-success" disabled>
                                                <i class="fas fa-hand-pointer me-2"></i>Simulate Activity
                                            </button>
                                            <button id="extend-session" class="btn btn-warning" disabled>
                                                <i class="fas fa-clock me-2"></i>Extend Session
                                            </button>
                                            <button id="reset-test" class="btn btn-secondary">
                                                <i class="fas fa-redo me-2"></i>Reset Test
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Test Log</h5>
                            <div id="test-log" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                <div class="text-muted">Test log will appear here...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SessionTest {
            constructor() {
                this.sessionTimeout = 2 * 60 * 1000; // 2 minutes for testing
                this.warningTime = 30 * 1000; // 30 seconds before expiration
                this.checkInterval = 5 * 1000; // Check every 5 seconds
                this.lastActivity = Date.now();
                this.warningShown = false;
                this.isRunning = false;
                
                this.init();
            }
            
            init() {
                document.getElementById('start-test').addEventListener('click', () => this.startTest());
                document.getElementById('simulate-activity').addEventListener('click', () => this.simulateActivity());
                document.getElementById('extend-session').addEventListener('click', () => this.extendSession());
                document.getElementById('reset-test').addEventListener('click', () => this.resetTest());
                
                // Track activity
                this.trackActivity();
            }
            
            startTest() {
                this.isRunning = true;
                this.lastActivity = Date.now();
                this.warningShown = false;
                
                document.getElementById('start-test').disabled = true;
                document.getElementById('simulate-activity').disabled = false;
                document.getElementById('extend-session').disabled = false;
                
                this.log('Test started - Session will expire in 2 minutes');
                this.startMonitoring();
            }
            
            trackActivity() {
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                
                events.forEach(event => {
                    document.addEventListener(event, () => {
                        if (this.isRunning) {
                            this.lastActivity = Date.now();
                            this.warningShown = false;
                            this.updateStatus();
                        }
                    }, true);
                });
            }
            
            startMonitoring() {
                this.interval = setInterval(() => {
                    this.checkSession();
                }, this.checkInterval);
            }
            
            checkSession() {
                const now = Date.now();
                const timeSinceActivity = now - this.lastActivity;
                const timeUntilExpiration = this.sessionTimeout - timeSinceActivity;
                
                this.updateStatus();
                
                // Show warning if session is about to expire
                if (timeUntilExpiration <= this.warningTime && timeUntilExpiration > 0 && !this.warningShown) {
                    this.showWarning(timeUntilExpiration);
                }
                
                // Handle session expiration
                if (timeSinceActivity >= this.sessionTimeout) {
                    this.handleSessionExpiration();
                }
            }
            
            updateStatus() {
                const now = Date.now();
                const timeSinceActivity = now - this.lastActivity;
                const timeUntilExpiration = this.sessionTimeout - timeSinceActivity;
                
                document.getElementById('last-activity').textContent = new Date(this.lastActivity).toLocaleTimeString();
                
                if (timeUntilExpiration > 0) {
                    const minutes = Math.floor(timeUntilExpiration / 60000);
                    const seconds = Math.floor((timeUntilExpiration % 60000) / 1000);
                    document.getElementById('time-remaining').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('session-status').textContent = 'Active';
                    document.getElementById('session-status').className = 'badge bg-success';
                } else {
                    document.getElementById('time-remaining').textContent = 'Expired';
                    document.getElementById('session-status').textContent = 'Expired';
                    document.getElementById('session-status').className = 'badge bg-danger';
                }
            }
            
            showWarning(timeUntilExpiration) {
                this.warningShown = true;
                const seconds = Math.ceil(timeUntilExpiration / 1000);
                
                this.log(`⚠️ WARNING: Session will expire in ${seconds} seconds!`);
                
                // Show Bootstrap alert
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Session Expiring Soon!</strong> Your session will expire in ${seconds} seconds.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.card-body').insertBefore(alert, document.querySelector('.alert-info'));
            }
            
            simulateActivity() {
                this.lastActivity = Date.now();
                this.warningShown = false;
                this.log('✅ Activity simulated - Session extended');
                this.updateStatus();
            }
            
            extendSession() {
                this.lastActivity = Date.now();
                this.warningShown = false;
                this.log('✅ Session extended manually');
                this.updateStatus();
            }
            
            handleSessionExpiration() {
                this.log('❌ SESSION EXPIRED - User would be redirected to login');
                document.getElementById('session-status').textContent = 'Expired';
                document.getElementById('session-status').className = 'badge bg-danger';
                
                // Show expiration alert
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Session Expired!</strong> You would be redirected to the login page now.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.querySelector('.card-body').insertBefore(alert, document.querySelector('.alert-info'));
                
                this.stopTest();
            }
            
            resetTest() {
                this.stopTest();
                this.lastActivity = Date.now();
                this.warningShown = false;
                
                document.getElementById('start-test').disabled = false;
                document.getElementById('simulate-activity').disabled = true;
                document.getElementById('extend-session').disabled = true;
                
                document.getElementById('session-status').textContent = 'Ready';
                document.getElementById('session-status').className = 'badge bg-secondary';
                document.getElementById('last-activity').textContent = '-';
                document.getElementById('time-remaining').textContent = '-';
                
                // Clear alerts
                document.querySelectorAll('.alert:not(.alert-info)').forEach(alert => alert.remove());
                
                this.log('🔄 Test reset - Ready to start new test');
            }
            
            stopTest() {
                this.isRunning = false;
                if (this.interval) {
                    clearInterval(this.interval);
                }
            }
            
            log(message) {
                const logDiv = document.getElementById('test-log');
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="text-muted">[${time}]</span> ${message}`;
                logDiv.appendChild(logEntry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        // Initialize test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SessionTest();
        });
    </script>
</body>
</html>
