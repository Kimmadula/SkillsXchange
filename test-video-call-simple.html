<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Video Call Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        video { width: 100%; max-width: 300px; height: auto; background: #000; border-radius: 5px; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Simple Video Call Test</h1>
        
        <div id="status" class="status info">Ready to test...</div>
        
        <div style="display: flex; gap: 20px; margin: 20px 0;">
            <div>
                <h4>Local Video</h4>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h4>Remote Video (Simulated)</h4>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <button onclick="testBasicVideoCall()">Test Basic Video Call</button>
        <button onclick="testPusherConnection()">Test Pusher Connection</button>
        <button onclick="testTurnServers()">Test TURN Servers</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <h3>Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.textContent = logMessage;
            logEntry.style.color = type === 'error' ? '#dc3545' : 
                                  type === 'success' ? '#28a745' : 
                                  type === 'warning' ? '#ffc107' : '#333';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        async function testBasicVideoCall() {
            log('üé• Testing basic video call functionality...', 'info');
            updateStatus('Testing media access...', 'info');
            
            try {
                // Test 1: Media Access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                log('‚úÖ Media access granted', 'success');
                
                // Display local video
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;
                
                // Test 2: WebRTC Support
                if (window.RTCPeerConnection) {
                    log('‚úÖ WebRTC supported', 'success');
                    
                    // Test 3: Create Peer Connection
                    const iceServers = [
                        { urls: 'stun:stun.relay.metered.ca:80' },
                        {
                            urls: 'turn:asia.relay.metered.ca:80',
                            username: '0582eeabe15281e17e922394',
                            credential: 'g7fjNoaIyTpLnkaf'
                        }
                    ];
                    
                    const pc = new RTCPeerConnection({ iceServers });
                    log('‚úÖ Peer connection created', 'success');
                    
                    // Test 4: Add stream to peer connection
                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });
                    log('‚úÖ Stream added to peer connection', 'success');
                    
                    // Test 5: Create offer
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    log('‚úÖ Offer created successfully', 'success');
                    
                    // Test 6: ICE candidates
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            log(`ICE Candidate: ${event.candidate.candidate}`, 'info');
                        }
                    };
                    
                    pc.onicegatheringstatechange = () => {
                        log(`ICE Gathering State: ${pc.iceGatheringState}`, 'info');
                    };
                    
                    updateStatus('‚úÖ Basic video call test passed!', 'success');
                    log('üéâ All basic tests passed!', 'success');
                    
                } else {
                    log('‚ùå WebRTC not supported', 'error');
                    updateStatus('‚ùå WebRTC not supported', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testPusherConnection() {
            log('üì° Testing Pusher connection...', 'info');
            updateStatus('Testing Pusher...', 'info');
            
            if (typeof window.Pusher === 'undefined') {
                log('‚ùå Pusher library not loaded', 'error');
                updateStatus('‚ùå Pusher not loaded', 'error');
                return;
            }
            
            try {
                const pusher = new Pusher('5c02e54d01ca577ae77e', {
                    cluster: 'ap1',
                    forceTLS: true
                });
                
                pusher.connection.bind('connected', () => {
                    log('‚úÖ Pusher connected successfully', 'success');
                    updateStatus('‚úÖ Pusher connected!', 'success');
                });
                
                pusher.connection.bind('error', (error) => {
                    log(`‚ùå Pusher error: ${error.message}`, 'error');
                    updateStatus(`‚ùå Pusher error: ${error.message}`, 'error');
                });
                
                // Test timeout
                setTimeout(() => {
                    if (pusher.connection.state !== 'connected') {
                        log('‚è±Ô∏è Pusher connection timeout', 'warning');
                        updateStatus('‚è±Ô∏è Pusher timeout', 'warning');
                    }
                }, 5000);
                
            } catch (error) {
                log(`‚ùå Pusher error: ${error.message}`, 'error');
                updateStatus(`‚ùå Pusher error: ${error.message}`, 'error');
            }
        }
        
        async function testTurnServers() {
            log('üåê Testing TURN servers...', 'info');
            updateStatus('Testing TURN servers...', 'info');
            
            const iceServers = [
                { urls: 'stun:stun.relay.metered.ca:80' },
                {
                    urls: 'turn:asia.relay.metered.ca:80',
                    username: '0582eeabe15281e17e922394',
                    credential: 'g7fjNoaIyTpLnkaf'
                },
                {
                    urls: 'turn:asia.relay.metered.ca:443',
                    username: '0582eeabe15281e17e922394',
                    credential: 'g7fjNoaIyTpLnkaf'
                }
            ];
            
            try {
                const pc = new RTCPeerConnection({ iceServers });
                
                let candidatesReceived = 0;
                let turnCandidatesReceived = 0;
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        candidatesReceived++;
                        log(`ICE Candidate ${candidatesReceived}: ${event.candidate.candidate}`, 'info');
                        
                        if (event.candidate.candidate.includes('relay')) {
                            turnCandidatesReceived++;
                            log(`‚úÖ TURN candidate received!`, 'success');
                        }
                    }
                };
                
                pc.onicegatheringstatechange = () => {
                    log(`ICE Gathering State: ${pc.iceGatheringState}`, 'info');
                    
                    if (pc.iceGatheringState === 'complete') {
                        log(`‚úÖ ICE gathering complete. Total candidates: ${candidatesReceived}`, 'success');
                        log(`‚úÖ TURN candidates: ${turnCandidatesReceived}`, 'success');
                        
                        if (turnCandidatesReceived > 0) {
                            updateStatus('‚úÖ TURN servers working!', 'success');
                        } else {
                            updateStatus('‚ö†Ô∏è No TURN candidates received', 'warning');
                        }
                    }
                };
                
                // Create data channel to trigger ICE gathering
                pc.createDataChannel('test');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (pc.iceGatheringState !== 'complete') {
                        log('‚è±Ô∏è ICE gathering timeout', 'warning');
                        updateStatus('‚è±Ô∏è TURN test timeout', 'warning');
                    }
                }, 10000);
                
            } catch (error) {
                log(`‚ùå TURN test error: ${error.message}`, 'error');
                updateStatus(`‚ùå TURN test error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run basic test on page load
        window.addEventListener('load', function() {
            log('üöÄ Simple Video Call Test loaded', 'info');
            log('üìã Click "Test Basic Video Call" to begin', 'info');
        });
    </script>
</body>
</html>
