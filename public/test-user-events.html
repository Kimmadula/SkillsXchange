<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-csrf-token">
    <title>User Event Listening Test</title>
    
    <!-- Load Pusher and Laravel Echo libraries -->
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.iife.js"></script>
    
    <!-- Pusher Configuration -->
    <script>
        window.PUSHER_APP_KEY = '5c02e54d01ca577ae77e';
        window.PUSHER_APP_CLUSTER = 'ap1';
        
        console.log('üîß Pusher Configuration:');
        console.log('üîë Key:', window.PUSHER_APP_KEY);
        console.log('üåê Cluster:', window.PUSHER_APP_CLUSTER);
        
        // Initialize Laravel Echo
        try {
            window.Echo = new Echo({
                broadcaster: 'pusher',
                key: window.PUSHER_APP_KEY,
                cluster: window.PUSHER_APP_CLUSTER,
                forceTLS: true,
                enabledTransports: ['ws', 'wss'],
                authEndpoint: '/broadcasting/auth',
                auth: {
                    headers: {
                        'X-CSRF-TOKEN': 'test-csrf-token',
                        'Accept': 'application/json'
                    }
                },
                // Add error handling
                error: function(error) {
                    console.error('‚ùå Echo error:', error);
                }
            });
            
            console.log('‚úÖ Laravel Echo initialized successfully');
            
            // Test connection
            window.Echo.connector.pusher.connection.bind('connected', () => {
                console.log('‚úÖ Pusher connected successfully');
            });
            
            window.Echo.connector.pusher.connection.bind('error', (error) => {
                console.error('‚ùå Pusher connection error:', error);
            });
            
        } catch (error) {
            console.error('‚ùå Failed to initialize Laravel Echo:', error);
            window.Echo = null;
        }
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .log-entry.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .log-entry.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .log-entry.warning {
            background: #fff8e1;
            color: #f57c00;
        }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .user-card {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }
        
        .user-card.active {
            border-color: #51cf66;
            background: #f8fff9;
        }
        
        .user-card.inactive {
            border-color: #ff6b6b;
            background: #fff8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç User Event Listening Test</h1>
        
        <div class="test-section">
            <h3>üì° Connection Status</h3>
            <div id="connection-status" class="status info">Checking connection...</div>
            <div id="pusher-status" class="status info">Checking Pusher...</div>
            <div id="echo-status" class="status info">Checking Laravel Echo...</div>
        </div>
        
        <div class="test-section">
            <h3>üë• User Information</h3>
            <div class="user-info">
                <div class="user-card" id="user1-card">
                    <h4>User 1 (You)</h4>
                    <div id="user1-status">Unknown</div>
                    <div id="user1-id">ID: Loading...</div>
                </div>
                <div class="user-card" id="user2-card">
                    <h4>User 2 (Partner)</h4>
                    <div id="user2-status">Unknown</div>
                    <div id="user2-id">ID: Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Event Listening Tests</h3>
            <button class="test-button" onclick="testMessageEvents()">Test Message Events</button>
            <button class="test-button" onclick="testVideoCallEvents()">Test Video Call Events</button>
            <button class="test-button" onclick="testUserPresenceEvents()">Test User Presence</button>
            <button class="test-button" onclick="testTaskEvents()">Test Task Events</button>
            <button class="test-button" onclick="testRealEventSending()">Test Real Event Sending</button>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="test-section">
            <h3>üìã Event Log</h3>
            <div id="event-log" class="log">
                <div class="log-entry info">Event log initialized. Click test buttons to see events...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîß Debug Information</h3>
            <div id="debug-info" class="log">
                <div class="log-entry info">Loading debug information...</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let pusher = null;
        let echo = null;
        let tradeId = null;
        let userId = null;
        let partnerId = null;
        let eventLog = [];
        
        // Initialize the test
        async function initializeTest() {
            log('info', 'üöÄ Initializing user event listening test...');
            
            // Check if we're in a trade context
            const urlParams = new URLSearchParams(window.location.search);
            tradeId = urlParams.get('trade_id') || '1';
            userId = urlParams.get('user_id') || '1';
            partnerId = urlParams.get('partner_id') || '2';
            
            log('info', `üìä Test Parameters: Trade ID: ${tradeId}, User ID: ${userId}, Partner ID: ${partnerId}`);
            
            // Update user cards
            document.getElementById('user1-id').textContent = `ID: ${userId}`;
            document.getElementById('user2-id').textContent = `ID: ${partnerId}`;
            
            // Check Pusher availability
            if (typeof window.Pusher !== 'undefined') {
                document.getElementById('pusher-status').innerHTML = '<span class="status success">‚úÖ Pusher Available</span>';
                log('success', '‚úÖ Pusher is available');
            } else {
                document.getElementById('pusher-status').innerHTML = '<span class="status error">‚ùå Pusher Not Available</span>';
                log('error', '‚ùå Pusher is not available');
            }
            
            // Check Laravel Echo availability
            if (typeof window.Echo !== 'undefined') {
                document.getElementById('echo-status').innerHTML = '<span class="status success">‚úÖ Laravel Echo Available</span>';
                log('success', '‚úÖ Laravel Echo is available');
            } else {
                document.getElementById('echo-status').innerHTML = '<span class="status error">‚ùå Laravel Echo Not Available</span>';
                log('error', '‚ùå Laravel Echo is not available');
            }
            
            // Test connection
            await testConnection();
        }
        
        async function testConnection() {
            try {
                log('info', 'üîó Testing connection...');
                
                if (typeof window.Echo !== 'undefined') {
                    // Test Echo connection
                    const channel = window.Echo.channel(`trade-${tradeId}`);
                    
                    channel.listen('user-joined', function(data) {
                        log('success', `üë§ User joined event received: ${JSON.stringify(data)}`);
                    });
                    
                    channel.listen('user-left', function(data) {
                        log('success', `üë§ User left event received: ${JSON.stringify(data)}`);
                    });
                    
                    channel.listen('new-message', function(data) {
                        log('success', `üí¨ New message event received: ${JSON.stringify(data)}`);
                    });
                    
                    channel.listen('task-updated', function(data) {
                        log('success', `üìã Task updated event received: ${JSON.stringify(data)}`);
                    });
                    
                    // Test private channel for video calls
                    const privateChannel = window.Echo.private(`trade.${tradeId}`);
                    
                    privateChannel.listen('video-call-offer', function(data) {
                        log('success', `üìû Video call offer received: ${JSON.stringify(data)}`);
                    });
                    
                    privateChannel.listen('video-call-answer', function(data) {
                        log('success', `üìû Video call answer received: ${JSON.stringify(data)}`);
                    });
                    
                    privateChannel.listen('video-call-ice-candidate', function(data) {
                        log('success', `üìû ICE candidate received: ${JSON.stringify(data)}`);
                    });
                    
                    privateChannel.listen('video-call-end', function(data) {
                        log('success', `üìû Video call end received: ${JSON.stringify(data)}`);
                    });
                    
                    // Add error handling for channels
                    channel.error((error) => {
                        log('error', `‚ùå Channel error: ${error.message || error}`);
                    });
                    
                    privateChannel.error((error) => {
                        log('error', `‚ùå Private channel error: ${error.message || error}`);
                    });
                    
                    // Add subscription error handling
                    privateChannel.subscription_error((error) => {
                        log('error', `‚ùå Private channel subscription error: ${error.message || error}`);
                        log('info', 'üí° This is expected for test page - private channels require authentication');
                    });
                    
                    // Check connection status
                    if (window.Echo.connector && window.Echo.connector.pusher) {
                        const connectionState = window.Echo.connector.pusher.connection.state;
                        log('info', `üîó Pusher connection state: ${connectionState}`);
                        
                        if (connectionState === 'connected') {
                            document.getElementById('connection-status').innerHTML = '<span class="status success">‚úÖ Connected to channels</span>';
                            log('success', '‚úÖ Successfully connected to all channels');
                        } else {
                            document.getElementById('connection-status').innerHTML = '<span class="status warning">‚ö†Ô∏è Connecting to channels...</span>';
                            log('warning', '‚ö†Ô∏è Connection in progress...');
                        }
                    } else {
                        document.getElementById('connection-status').innerHTML = '<span class="status error">‚ùå Pusher connector not available</span>';
                        log('error', '‚ùå Pusher connector not available');
                    }
                    
                } else {
                    document.getElementById('connection-status').innerHTML = '<span class="status error">‚ùå Laravel Echo not available</span>';
                    log('error', '‚ùå Laravel Echo is not available');
                }
                
            } catch (error) {
                document.getElementById('connection-status').innerHTML = '<span class="status error">‚ùå Connection failed</span>';
                log('error', `‚ùå Connection failed: ${error.message}`);
            }
        }
        
        function testMessageEvents() {
            log('info', 'üí¨ Testing message events...');
            
            // Simulate receiving a message
            setTimeout(() => {
                const mockMessage = {
                    message: {
                        id: Date.now(),
                        sender_id: partnerId,
                        content: 'Test message from partner',
                        created_at: new Date().toISOString()
                    },
                    sender_name: 'Test Partner',
                    timestamp: new Date().toLocaleTimeString()
                };
                
                log('success', `üí¨ Simulated message event: ${JSON.stringify(mockMessage)}`);
            }, 1000);
        }
        
        function testVideoCallEvents() {
            log('info', 'üìû Testing video call events...');
            
            // Simulate video call offer
            setTimeout(() => {
                const mockOffer = {
                    fromUserId: partnerId,
                    toUserId: userId,
                    offer: { type: 'offer', sdp: 'mock-sdp' },
                    callId: 'test-call-' + Date.now()
                };
                
                log('success', `üìû Simulated video call offer: ${JSON.stringify(mockOffer)}`);
            }, 1000);
            
            // Simulate video call answer
            setTimeout(() => {
                const mockAnswer = {
                    toUserId: userId,
                    answer: { type: 'answer', sdp: 'mock-sdp' },
                    callId: 'test-call-' + Date.now()
                };
                
                log('success', `üìû Simulated video call answer: ${JSON.stringify(mockAnswer)}`);
            }, 2000);
        }
        
        function testUserPresenceEvents() {
            log('info', 'üë§ Testing user presence events...');
            
            // Simulate user joined
            setTimeout(() => {
                const mockUserJoined = {
                    user_id: partnerId,
                    user_name: 'Test Partner',
                    timestamp: new Date().toISOString()
                };
                
                log('success', `üë§ Simulated user joined: ${JSON.stringify(mockUserJoined)}`);
            }, 1000);
            
            // Simulate user left
            setTimeout(() => {
                const mockUserLeft = {
                    user_id: partnerId,
                    user_name: 'Test Partner',
                    timestamp: new Date().toISOString()
                };
                
                log('success', `üë§ Simulated user left: ${JSON.stringify(mockUserLeft)}`);
            }, 2000);
        }
        
        function testTaskEvents() {
            log('info', 'üìã Testing task events...');
            
            // Simulate task update
            setTimeout(() => {
                const mockTask = {
                    id: 1,
                    title: 'Test Task',
                    status: 'completed',
                    updated_at: new Date().toISOString()
                };
                
                log('success', `üìã Simulated task update: ${JSON.stringify(mockTask)}`);
            }, 1000);
        }
        
        async function testRealEventSending() {
            log('info', 'üöÄ Testing real event sending...');
            
            // First, get a real CSRF token
            try {
                const csrfResponse = await fetch('/sanctum/csrf-cookie');
                if (csrfResponse.ok) {
                    log('success', '‚úÖ CSRF cookie obtained');
                }
            } catch (error) {
                log('warning', '‚ö†Ô∏è Could not get CSRF cookie, using test token');
            }
            
            // Test sending a real message event (simulate via console)
            try {
                log('info', 'üì§ Simulating real message event...');
                
                // Simulate a real message event that would be sent by another user
                const mockMessageEvent = {
                    message: {
                        id: Date.now(),
                        sender_id: partnerId,
                        content: 'Real test message from partner',
                        created_at: new Date().toISOString()
                    },
                    sender_name: 'Real Test Partner',
                    timestamp: new Date().toLocaleTimeString()
                };
                
                // Trigger the event listener manually
                if (window.Echo && window.Echo.channel) {
                    const channel = window.Echo.channel(`trade-${tradeId}`);
                    // Simulate the event
                    setTimeout(() => {
                        log('success', `üì§ Real message event simulated: ${JSON.stringify(mockMessageEvent)}`);
                    }, 500);
                }
                
            } catch (error) {
                log('error', `‚ùå Error simulating real message event: ${error.message}`);
            }
            
            // Test sending a real video call offer (simulate via console)
            try {
                log('info', 'üì§ Simulating real video call offer...');
                
                const mockVideoCallEvent = {
                    fromUserId: partnerId,
                    toUserId: userId,
                    offer: { type: 'offer', sdp: 'real-test-sdp' },
                    callId: 'real-test-call-' + Date.now()
                };
                
                // Trigger the event listener manually
                if (window.Echo && window.Echo.private) {
                    const privateChannel = window.Echo.private(`trade.${tradeId}`);
                    // Simulate the event
                    setTimeout(() => {
                        log('success', `üì§ Real video call offer simulated: ${JSON.stringify(mockVideoCallEvent)}`);
                    }, 1000);
                }
                
            } catch (error) {
                log('error', `‚ùå Error simulating real video call offer: ${error.message}`);
            }
        }
        
        function log(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            const logContainer = document.getElementById('event-log');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Also add to debug info
            const debugContainer = document.getElementById('debug-info');
            const debugEntry = document.createElement('div');
            debugEntry.className = `log-entry ${type}`;
            debugEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            debugContainer.appendChild(debugEntry);
            debugContainer.scrollTop = debugContainer.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('event-log').innerHTML = '<div class="log-entry info">Event log cleared...</div>';
            document.getElementById('debug-info').innerHTML = '<div class="log-entry info">Debug info cleared...</div>';
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>
</html>
